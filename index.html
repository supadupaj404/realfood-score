<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1E3A2F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Food Score">
    <meta name="description" content="Scan barcodes to see how real your food is. Based on MAHA priorities.">
    <meta name="mobile-web-app-capable" content="yes">

    <title>Real Food Score</title>

    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">

    <!-- Fonts & Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700;800;900&family=Source+Serif+4:ital,opsz,wght@0,8..60,400;0,8..60,500;0,8..60,600;1,8..60,400;1,8..60,500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
            --cream: #F3F0D6;
            --cream-dark: #E8E4C9;
            --forest: #1E3A2F;
            --forest-light: #2D5A47;
            --sage: #A8B5A0;
            --sage-light: #D4DDD0;
            --terracotta: #C75B39;
            --terracotta-light: #F5E6E0;
            --gold: #B8860B;
            --gold-light: #F5EED6;
            --black: #1A1A1A;
            --charcoal: #2C2C2C;
            --stone: #6B6B6B;
            --mist: #9A9A9A;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Public Sans', -apple-system, sans-serif;
            background: var(--cream);
            color: var(--charcoal);
            min-height: 100vh;
            min-height: 100dvh;
            line-height: 1.6;
            font-size: 16px;
            overflow-x: hidden;
        }

        /* Organic background shapes */
        .bg-shapes {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
        }

        .bg-shape-1 {
            width: 400px;
            height: 400px;
            background: var(--sage);
            top: -100px;
            right: -100px;
            animation: float1 20s ease-in-out infinite;
        }

        .bg-shape-2 {
            width: 300px;
            height: 300px;
            background: var(--gold-light);
            bottom: 20%;
            left: -80px;
            animation: float2 25s ease-in-out infinite;
        }

        .bg-shape-3 {
            width: 250px;
            height: 250px;
            background: var(--sage-light);
            top: 40%;
            right: -60px;
            animation: float3 18s ease-in-out infinite;
        }

        @keyframes float1 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-30px, 30px) scale(1.1); }
        }

        @keyframes float2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(20px, -20px) scale(1.05); }
        }

        @keyframes float3 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-20px, 15px) scale(0.95); }
        }

        .app {
            position: relative;
            z-index: 1;
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            padding: 0 1.5rem 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .app.has-results {
            justify-content: flex-start;
            padding-top: 1rem;
        }

        /* Header */
        header {
            padding: 0 0 1.25rem;
            text-align: center;
            animation: fadeDown 0.6s ease-out;
        }

        @keyframes fadeDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .gov-badge {
            display: inline-block;
            padding: 0.4rem 1rem;
            background: var(--forest);
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--cream);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.75rem;
        }

        .logo {
            font-family: 'Public Sans', sans-serif;
            font-size: 2.75rem;
            font-weight: 900;
            color: var(--black);
            letter-spacing: -0.05em;
            line-height: 1;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow:
                0 2px 8px rgba(30, 58, 47, 0.04),
                0 8px 32px rgba(30, 58, 47, 0.08);
            animation: fadeUp 0.5s ease-out;
            animation-fill-mode: both;
        }

        .card:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3) { animation-delay: 0.2s; }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tabs */
        .input-tabs {
            display: flex;
            background: var(--cream);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 1.25rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.7rem 1rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--stone);
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .tab-btn.active {
            background: white;
            color: var(--forest);
            box-shadow: 0 2px 8px rgba(30, 58, 47, 0.1);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Form elements */
        .input-group { margin-bottom: 1rem; }

        label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--forest);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input, textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--cream-dark);
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            color: var(--charcoal);
            background: white;
            transition: all 0.2s ease;
            outline: none;
        }

        input:focus, textarea:focus {
            border-color: var(--forest-light);
            box-shadow: 0 0 0 4px rgba(45, 90, 71, 0.1);
        }

        input::placeholder, textarea::placeholder { color: var(--mist); }
        textarea { min-height: 100px; resize: vertical; line-height: 1.5; }

        .input-hint {
            font-size: 0.75rem;
            color: var(--mist);
            margin-top: 0.4rem;
        }

        /* Button */
        .btn-primary {
            width: 100%;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(30, 58, 47, 0.25);
            transition: all 0.25s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(30, 58, 47, 0.3);
        }

        .btn-primary:active { transform: translateY(0); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-icon { width: 20px; height: 20px; }

        /* Results */
        .results { display: none; }
        .results.visible { display: block; }

        .result-header {
            text-align: center;
            padding: 1rem 0 0.5rem;
            animation: fadeUp 0.4s ease-out;
        }

        .product-name {
            font-family: 'Public Sans', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--black);
            letter-spacing: -0.03em;
            line-height: 1.2;
            margin-bottom: 0.25rem;
        }

        .product-meta {
            font-family: 'Source Serif 4', Georgia, serif;
            font-style: italic;
            font-size: 0.95rem;
            color: var(--stone);
        }

        /* Score Display */
        .score-card {
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem 1.5rem 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
            box-shadow:
                0 4px 16px rgba(30, 58, 47, 0.06),
                0 12px 48px rgba(30, 58, 47, 0.1);
            animation: fadeUp 0.5s ease-out 0.1s both;
        }

        .score-gauge {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 1.5rem;
        }

        .score-ring-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .score-ring-bg {
            fill: none;
            stroke: var(--cream);
            stroke-width: 14;
        }

        .score-ring-fill {
            fill: none;
            stroke: url(#scoreGradient);
            stroke-width: 14;
            stroke-linecap: round;
            stroke-dasharray: 502;
            stroke-dashoffset: 502;
            transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 8px rgba(30, 58, 47, 0.3));
        }

        .score-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 140px;
            height: 140px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(45, 90, 71, 0.08) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.6; }
        }

        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .score-number {
            font-family: 'Public Sans', sans-serif;
            font-size: 3.5rem;
            font-weight: 900;
            line-height: 1;
            color: var(--black);
            letter-spacing: -0.03em;
        }

        .score-grade {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 0.25rem;
            letter-spacing: 0.05em;
        }

        .grade-A { color: var(--forest); }
        .grade-B { color: var(--forest-light); }
        .grade-C { color: var(--gold); }
        .grade-D { color: #C4762C; }
        .grade-F { color: var(--terracotta); }

        /* Score type selector */
        .score-types {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .score-type-btn {
            padding: 0.5rem 1rem;
            border: 1.5px solid var(--cream-dark);
            background: white;
            border-radius: 100px;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--stone);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .score-type-btn:hover { border-color: var(--sage); }

        .score-type-btn.active {
            background: var(--forest);
            border-color: var(--forest);
            color: white;
        }

        .score-description {
            font-family: 'Source Serif 4', Georgia, serif;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--stone);
            margin-bottom: 1.25rem;
        }

        /* Mini scores */
        .all-scores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--cream-dark);
        }

        .mini-score {
            text-align: center;
            padding: 0.875rem 0.5rem;
            background: var(--cream);
            border-radius: 12px;
        }

        .mini-score-label {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--mist);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.35rem;
        }

        .mini-score-value {
            font-family: 'Public Sans', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            line-height: 1;
        }

        .mini-score-grade {
            font-size: 0.7rem;
            font-weight: 700;
            margin-top: 0.2rem;
            letter-spacing: 0.03em;
        }

        /* Analysis section */
        .analysis-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 1.25rem;
            box-shadow: 0 2px 8px rgba(30, 58, 47, 0.04), 0 8px 32px rgba(30, 58, 47, 0.08);
            animation: fadeUp 0.5s ease-out 0.2s both;
            margin-bottom: 1rem;
        }

        .section-title {
            font-family: 'Public Sans', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--black);
            letter-spacing: -0.01em;
            margin-bottom: 0.875rem;
        }

        .flags-list { display: flex; flex-direction: column; gap: 0.6rem; }

        .flag-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--terracotta-light);
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--terracotta);
        }

        .flag-icon { width: 18px; height: 18px; flex-shrink: 0; }

        .clean-badge {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, var(--sage-light) 0%, rgba(168, 181, 160, 0.3) 100%);
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--forest);
        }

        /* Ingredients */
        .ingredients-grid { display: flex; flex-wrap: wrap; gap: 0.5rem; }

        .ingredient-tag {
            padding: 0.45rem 0.8rem;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .ingredient-tag:hover { transform: scale(1.05); }

        .ingredient-tag.whole {
            background: var(--sage-light);
            color: var(--forest);
        }

        .ingredient-tag.flagged {
            background: var(--terracotta-light);
            color: var(--terracotta);
        }

        .ingredient-tag.neutral {
            background: var(--cream);
            color: var(--stone);
        }

        .recommendations {
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--cream-dark);
        }

        .recommendation {
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
            font-size: 0.9rem;
            color: var(--stone);
            margin-bottom: 0.6rem;
        }

        .rec-icon {
            color: var(--forest-light);
            font-weight: 600;
            flex-shrink: 0;
        }

        /* Footer */
        footer {
            padding: 1.5rem 0;
            text-align: center;
        }

        .footer-link {
            font-size: 0.75rem;
            color: var(--stone);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 100px;
            background: rgba(255,255,255,0.5);
            transition: all 0.2s ease;
        }

        .footer-link:hover {
            background: white;
            color: var(--forest);
        }

        /* Settings panel */
        .settings-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            color: var(--stone);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            z-index: 100;
        }

        .settings-toggle:hover {
            background: white;
            color: var(--forest);
            transform: scale(1.05);
        }

        .settings-toggle svg {
            width: 20px;
            height: 20px;
        }

        .settings-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            animation: fadeIn 0.2s ease;
        }

        .settings-panel.visible {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .settings-content {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: fadeUp 0.3s ease;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .settings-title {
            font-family: 'Public Sans', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--black);
        }

        .settings-close {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: var(--cream);
            color: var(--stone);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .settings-close:hover {
            background: var(--terracotta-light);
            color: var(--terracotta);
        }

        .settings-section {
            margin-bottom: 1.25rem;
        }

        .settings-section-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--mist);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.8rem;
            background: var(--cream);
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .api-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--mist);
        }

        .api-status-dot.active {
            background: var(--forest);
        }

        .api-status-name {
            font-weight: 600;
            color: var(--charcoal);
        }

        .api-status-label {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--stone);
        }

        .api-key-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--cream-dark);
            border-radius: 10px;
            font-family: 'SF Mono', monospace;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .api-key-input:focus {
            border-color: var(--forest-light);
            outline: none;
        }

        .api-key-hint {
            font-size: 0.75rem;
            color: var(--mist);
            line-height: 1.4;
        }

        .api-key-hint a {
            color: var(--forest);
            text-decoration: none;
        }

        .api-key-hint a:hover {
            text-decoration: underline;
        }

        .save-btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            background: var(--forest);
            color: white;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 0.75rem;
        }

        .save-btn:hover {
            background: var(--forest-light);
        }

        /* Data source badge */
        .data-source {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.6rem;
            background: var(--cream);
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--stone);
            margin-top: 0.5rem;
        }

        .data-source-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--forest);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Scanner styles */
        .scan-options {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .scan-btn {
            flex: 1;
            padding: 0.75rem;
            border: 2px dashed var(--cream-dark);
            background: white;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--stone);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
        }

        .scan-btn:hover {
            border-color: var(--forest-light);
            color: var(--forest);
            background: var(--sage-light);
        }

        .scan-btn.active {
            border-color: var(--forest);
            border-style: solid;
            background: var(--sage-light);
            color: var(--forest);
        }

        .scan-btn svg {
            width: 24px;
            height: 24px;
        }

        .scan-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            color: var(--mist);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .scan-divider::before,
        .scan-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--cream-dark);
        }

        .camera-container {
            display: none;
            margin-bottom: 1rem;
        }

        .camera-container.active {
            display: block;
        }

        #camera-preview {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: var(--charcoal);
        }

        #camera-preview video {
            width: 100%;
            display: block;
        }

        .camera-status {
            text-align: center;
            padding: 2rem;
            color: var(--stone);
            font-size: 0.85rem;
        }

        .camera-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .capture-btn {
            flex: 1;
            padding: 0.875rem 1rem;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
            color: white;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 16px rgba(30, 58, 47, 0.25);
            transition: all 0.2s ease;
        }

        .capture-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(30, 58, 47, 0.3);
        }

        .capture-btn:active {
            transform: scale(0.98);
        }

        .capture-btn svg {
            width: 24px;
            height: 24px;
        }

        .stop-camera-btn {
            padding: 0.875rem 1.25rem;
            border: none;
            border-radius: 12px;
            background: var(--terracotta-light);
            color: var(--terracotta);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stop-camera-btn:hover {
            background: var(--terracotta);
            color: white;
        }

        .paste-zone {
            display: none;
            padding: 2rem;
            border: 2px dashed var(--cream-dark);
            border-radius: 12px;
            text-align: center;
            margin-bottom: 1rem;
            background: white;
            transition: all 0.2s ease;
        }

        .paste-zone.active {
            display: block;
        }

        .paste-zone.dragover {
            border-color: var(--forest);
            background: var(--sage-light);
        }

        .paste-zone-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 0.75rem;
            color: var(--mist);
        }

        .paste-zone-text {
            font-size: 0.9rem;
            color: var(--stone);
            margin-bottom: 0.5rem;
        }

        .paste-zone-hint {
            font-size: 0.75rem;
            color: var(--mist);
        }

        .file-input {
            display: none;
        }

        .scan-result {
            display: none;
            padding: 0.75rem 1rem;
            background: var(--sage-light);
            border-radius: 10px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: var(--forest);
        }

        .scan-result.visible {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scan-result.error {
            background: var(--terracotta-light);
            color: var(--terracotta);
        }

        .scan-result svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        /* Responsive */
        @media (max-width: 400px) {
            .score-gauge { width: 160px; height: 160px; }
            .score-number { font-size: 3rem; }
            .score-types { flex-wrap: wrap; }
            .all-scores { gap: 0.5rem; }
            .mini-score { padding: 0.75rem 0.25rem; }
            .mini-score-value { font-size: 1.5rem; }
            .scan-options { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- Settings toggle button -->
    <button class="settings-toggle" id="settings-toggle" aria-label="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
    </button>

    <!-- Settings panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-content">
            <div class="settings-header">
                <h2 class="settings-title">Settings</h2>
                <button class="settings-close" id="settings-close">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Data Sources</div>
                <div class="api-status">
                    <div class="api-status-dot active"></div>
                    <span class="api-status-name">Open Food Facts</span>
                    <span class="api-status-label">Always active</span>
                </div>
                <div class="api-status">
                    <div class="api-status-dot" id="usda-status-dot"></div>
                    <span class="api-status-name">USDA FoodData</span>
                    <span class="api-status-label" id="usda-status-label">Not configured</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">USDA API Key</div>
                <input type="text" class="api-key-input" id="usda-api-key" placeholder="Enter your API key...">
                <p class="api-key-hint">
                    Get a free API key from <a href="https://fdc.nal.usda.gov/api-key-signup.html" target="_blank" rel="noopener">USDA FoodData Central</a>.
                    Adds ~400K additional products.
                </p>
                <button class="save-btn" id="save-settings">Save Settings</button>
            </div>
        </div>
    </div>

    <div class="bg-shapes">
        <div class="bg-shape bg-shape-1"></div>
        <div class="bg-shape bg-shape-2"></div>
        <div class="bg-shape bg-shape-3"></div>
    </div>

    <div class="app">
        <header>
            <h1 class="logo">Real Food Score</h1>
        </header>

        <main>
            <div class="card">
                <div class="input-tabs">
                    <button class="tab-btn active" data-tab="barcode">Scan Barcode</button>
                    <button class="tab-btn" data-tab="manual">Enter Ingredients</button>
                </div>

                <div class="tab-content active" id="tab-barcode">
                    <!-- Scan options -->
                    <div class="scan-options">
                        <button class="scan-btn" id="camera-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                <circle cx="12" cy="13" r="4"/>
                            </svg>
                            <span>Use Camera</span>
                        </button>
                        <button class="scan-btn" id="upload-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <span>Upload Image</span>
                        </button>
                    </div>
                    <input type="file" id="file-input" class="file-input" accept="image/*">

                    <!-- Camera preview -->
                    <div class="camera-container" id="camera-container">
                        <div id="camera-preview"></div>
                        <div class="camera-controls">
                            <button class="capture-btn" id="capture-btn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <circle cx="12" cy="12" r="6" fill="currentColor"/>
                                </svg>
                                <span>Scan Now</span>
                            </button>
                            <button class="stop-camera-btn" id="stop-camera-btn">Stop</button>
                        </div>
                    </div>

                    <!-- Paste/drop zone -->
                    <div class="paste-zone" id="paste-zone">
                        <svg class="paste-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        <p class="paste-zone-text">Paste or drop barcode image here</p>
                        <p class="paste-zone-hint">Press Ctrl+V / Cmd+V to paste from clipboard</p>
                    </div>

                    <!-- Scan result -->
                    <div class="scan-result" id="scan-result">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span id="scan-result-text">Barcode detected</span>
                    </div>

                    <div class="scan-divider">or enter manually</div>

                    <div class="input-group">
                        <label for="barcode">UPC / Barcode</label>
                        <input type="text" id="barcode" inputmode="numeric" pattern="[0-9]*" placeholder="Enter the barcode number">
                    </div>
                    <button class="btn-primary" id="lookup-btn">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <span id="lookup-btn-text">Look Up Product</span>
                    </button>
                </div>

                <div class="tab-content" id="tab-manual">
                    <div class="input-group">
                        <label for="product-name">Product Name</label>
                        <input type="text" id="product-name" placeholder="e.g., Organic Peanut Butter">
                    </div>
                    <div class="input-group">
                        <label for="ingredients">Ingredients List</label>
                        <textarea id="ingredients" placeholder="Copy and paste the ingredients from the label..."></textarea>
                        <p class="input-hint">Usually found near the Nutrition Facts panel</p>
                    </div>
                    <button class="btn-primary" id="analyze-btn">Analyze Ingredients</button>
                </div>

            </div>

            <div class="results" id="results">
                <div class="result-header">
                    <h2 class="product-name" id="result-name">Product Name</h2>
                    <p class="product-meta"><span id="ingredient-count">0</span> ingredients analyzed</p>
                    <div class="data-source" id="data-source" style="display: none;">
                        <div class="data-source-dot"></div>
                        <span id="data-source-name">Open Food Facts</span>
                    </div>
                </div>

                <div class="score-card">
                    <div class="score-gauge">
                        <div class="score-glow"></div>
                        <svg class="score-ring-svg" viewBox="0 0 200 200">
                            <defs>
                                <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#1E3A2F"/>
                                    <stop offset="100%" style="stop-color:#2D5A47"/>
                                </linearGradient>
                                <linearGradient id="scoreGradientB" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#2D5A47"/>
                                    <stop offset="100%" style="stop-color:#4A7A5F"/>
                                </linearGradient>
                                <linearGradient id="scoreGradientC" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#B8860B"/>
                                    <stop offset="100%" style="stop-color:#D4A017"/>
                                </linearGradient>
                                <linearGradient id="scoreGradientD" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#C4762C"/>
                                    <stop offset="100%" style="stop-color:#E8923A"/>
                                </linearGradient>
                                <linearGradient id="scoreGradientF" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#C75B39"/>
                                    <stop offset="100%" style="stop-color:#E07050"/>
                                </linearGradient>
                            </defs>
                            <circle class="score-ring-bg" cx="100" cy="100" r="80"/>
                            <circle class="score-ring-fill" id="score-ring" cx="100" cy="100" r="80"/>
                        </svg>
                        <div class="score-value">
                            <div class="score-number" id="score-number">--</div>
                            <div class="score-grade" id="score-grade-label">-</div>
                        </div>
                    </div>

                    <div class="score-types" id="score-types">
                        <button class="score-type-btn active" data-type="rfk">MAHA</button>
                        <button class="score-type-btn" data-type="guideline">Guideline</button>
                        <button class="score-type-btn" data-type="practical">Practical</button>
                    </div>

                    <p class="score-description" id="score-description">Based on RFK Jr.'s stated priorities</p>

                    <div class="all-scores" id="all-scores"></div>
                </div>

                <div class="analysis-card">
                    <h3 class="section-title">Analysis</h3>
                    <div class="flags-list" id="flags-list"></div>
                </div>

                <div class="analysis-card">
                    <h3 class="section-title">Ingredients</h3>
                    <div class="ingredients-grid" id="ingredients-grid"></div>
                    <div class="recommendations" id="recommendations"></div>
                </div>
            </div>
        </main>

        <footer>
            <a class="footer-link" href="https://realfood.gov" target="_blank" rel="noopener">Based on realfood.gov 2025 Guidelines</a>
        </footer>
    </div>

    <script>
        // ============================================================
        // SETTINGS & API CONFIGURATION
        // ============================================================

        const USDA_API_BASE = 'https://api.nal.usda.gov/fdc/v1';
        const DEFAULT_USDA_KEY = 'sITpktEZSmwf2qG1Yez3bpxdpvL3xjLvHFHxkCPI';
        let usdaApiKey = localStorage.getItem('usda_api_key') || DEFAULT_USDA_KEY;

        // Settings panel handlers
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsClose = document.getElementById('settings-close');
        const saveSettingsBtn = document.getElementById('save-settings');
        const usdaApiKeyInput = document.getElementById('usda-api-key');
        const usdaStatusDot = document.getElementById('usda-status-dot');
        const usdaStatusLabel = document.getElementById('usda-status-label');

        function updateUsdaStatus() {
            if (usdaApiKey) {
                usdaStatusDot.classList.add('active');
                usdaStatusLabel.textContent = 'Active';
            } else {
                usdaStatusDot.classList.remove('active');
                usdaStatusLabel.textContent = 'Not configured';
            }
        }

        settingsToggle.addEventListener('click', () => {
            settingsPanel.classList.add('visible');
            usdaApiKeyInput.value = usdaApiKey;
            updateUsdaStatus();
        });

        settingsClose.addEventListener('click', () => {
            settingsPanel.classList.remove('visible');
        });

        settingsPanel.addEventListener('click', (e) => {
            if (e.target === settingsPanel) {
                settingsPanel.classList.remove('visible');
            }
        });

        saveSettingsBtn.addEventListener('click', () => {
            usdaApiKey = usdaApiKeyInput.value.trim();
            localStorage.setItem('usda_api_key', usdaApiKey);
            updateUsdaStatus();
            settingsPanel.classList.remove('visible');
        });

        // Initialize status on load
        updateUsdaStatus();

        // ============================================================
        // API LOOKUP FUNCTIONS
        // ============================================================

        // Open Food Facts lookup
        async function lookupOpenFoodFacts(barcode) {
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
                const data = await response.json();

                if (data.status !== 1 || !data.product) {
                    return null;
                }

                const product = data.product;
                return {
                    source: 'Open Food Facts',
                    name: product.product_name || 'Unknown Product',
                    brand: product.brands || '',
                    ingredients: product.ingredients_text || '',
                    image: product.image_url || ''
                };
            } catch (e) {
                console.error('Open Food Facts error:', e);
                return null;
            }
        }

        // USDA FoodData Central lookup
        async function lookupUSDA(barcode) {
            if (!usdaApiKey) return null;

            try {
                // USDA stores UPCs in various formats, try multiple searches
                const variations = [
                    barcode,                              // Original
                    barcode.padStart(14, '0'),            // GTIN-14 format
                    '00' + barcode,                       // With leading zeros
                    barcode.replace(/^0+/, '')            // Without leading zeros
                ];

                for (const upc of [...new Set(variations)]) {
                    const response = await fetch(
                        `${USDA_API_BASE}/foods/search?query=${upc}&dataType=Branded&pageSize=10&api_key=${usdaApiKey}`
                    );
                    const data = await response.json();

                    if (data.foods && data.foods.length > 0) {
                        // Find exact UPC match first
                        let product = data.foods.find(f =>
                            f.gtinUpc === upc ||
                            f.gtinUpc === barcode ||
                            f.gtinUpc?.replace(/^0+/, '') === barcode.replace(/^0+/, '')
                        );

                        // If no exact match, use first result if UPC is in the search
                        if (!product && data.foods[0].gtinUpc) {
                            product = data.foods[0];
                        }

                        if (product) {
                            return {
                                source: 'USDA FoodData',
                                name: product.description || 'Unknown Product',
                                brand: product.brandOwner || product.brandName || '',
                                ingredients: product.ingredients || '',
                                fdcId: product.fdcId
                            };
                        }
                    }
                }

                return null;
            } catch (e) {
                console.error('USDA API error:', e);
                return null;
            }
        }

        // Combined lookup - queries both APIs in parallel
        async function lookupProduct(barcode) {
            const promises = [lookupOpenFoodFacts(barcode)];

            if (usdaApiKey) {
                promises.push(lookupUSDA(barcode));
            }

            const results = await Promise.all(promises);
            const [offResult, usdaResult] = results;

            // Prefer result with ingredients, prioritize OFF for ingredient data
            if (offResult && offResult.ingredients) {
                return offResult;
            }
            if (usdaResult && usdaResult.ingredients) {
                return usdaResult;
            }
            // Return whichever has a name
            if (offResult) return offResult;
            if (usdaResult) return usdaResult;

            return null;
        }

        // ============================================================
        // INGREDIENT DATABASES
        // ============================================================

        const ADDED_SUGARS = new Set(["sugar", "cane sugar", "brown sugar", "raw sugar", "powdered sugar", "high fructose corn syrup", "hfcs", "corn syrup", "maple syrup", "agave syrup", "agave nectar", "rice syrup", "brown rice syrup", "glucose", "fructose", "dextrose", "sucrose", "maltose", "fruit juice concentrate", "molasses", "maltodextrin", "honey", "tapioca syrup", "glucose syrup"]);
        const INDUSTRIAL_OILS = new Set(["vegetable oil", "soybean oil", "canola oil", "corn oil", "sunflower oil", "safflower oil", "cottonseed oil", "grapeseed oil", "hydrogenated oil", "partially hydrogenated oil", "shortening", "brominated vegetable oil"]);
        const ARTIFICIAL_PRESERVATIVES = new Set(["bha", "bht", "tbhq", "sodium benzoate", "potassium benzoate", "sodium nitrate", "sodium nitrite", "calcium propionate", "potassium sorbate", "edta", "disodium edta"]);
        const ARTIFICIAL_FLAVORS = new Set(["artificial flavor", "artificial flavors", "artificial flavoring", "natural and artificial flavors", "msg", "monosodium glutamate"]);
        const ARTIFICIAL_COLORS = new Set(["red 40", "red 3", "yellow 5", "yellow 6", "blue 1", "blue 2", "green 3", "caramel color", "artificial color", "titanium dioxide"]);
        const REFINED_GRAINS = new Set(["enriched flour", "enriched wheat flour", "bleached flour", "white flour", "modified food starch", "modified starch"]);
        const WHOLE_FOODS = new Set(["chicken", "beef", "pork", "fish", "salmon", "eggs", "egg", "milk", "cream", "butter", "cheese", "yogurt", "tomato", "tomatoes", "onion", "onions", "garlic", "carrot", "celery", "peppers", "broccoli", "spinach", "potato", "apple", "banana", "orange", "lemon", "berries", "whole wheat", "oats", "brown rice", "quinoa", "almonds", "walnuts", "peanuts", "olive oil", "avocado oil", "coconut oil", "salt", "sea salt", "pepper", "basil", "oregano", "water", "vinegar", "cheddar", "mozzarella", "parmesan", "whey", "buttermilk"]);

        const PENALTIES = {
            rfk: { added_sugar_first: 20, added_sugar_additional: 4, industrial_oil_first: 30, industrial_oil_additional: 8, preservative_first: 18, preservative_additional: 5, artificial_flavor: 20, artificial_color_first: 35, artificial_color_additional: 8, refined_grain: 8 },
            guideline: { added_sugar_first: 25, added_sugar_additional: 5, industrial_oil_first: 20, industrial_oil_additional: 5, preservative_first: 15, preservative_additional: 5, artificial_flavor: 15, artificial_color_first: 15, artificial_color_additional: 3, refined_grain: 10 },
            practical: { added_sugar_first: 12, added_sugar_additional: 3, industrial_oil_first: 10, industrial_oil_additional: 3, preservative_first: 8, preservative_additional: 3, artificial_flavor: 10, artificial_color_first: 15, artificial_color_additional: 3, refined_grain: 5 }
        };

        const SCORE_LABELS = {
            rfk: { label: "MAHA", description: "Based on RFK Jr.'s stated priorities" },
            guideline: { label: "Guideline", description: "Strict realfood.gov interpretation" },
            practical: { label: "Practical", description: "Compared to typical alternatives" }
        };

        const GRADE_GRADIENTS = { A: 'scoreGradient', B: 'scoreGradientB', C: 'scoreGradientC', D: 'scoreGradientD', F: 'scoreGradientF' };

        function classifyIngredient(name) {
            const lower = name.toLowerCase().trim();
            return {
                name: name.trim(),
                is_added_sugar: [...ADDED_SUGARS].some(s => lower.includes(s)),
                is_industrial_oil: [...INDUSTRIAL_OILS].some(s => lower.includes(s)),
                is_artificial_preservative: [...ARTIFICIAL_PRESERVATIVES].some(s => lower.includes(s)),
                is_artificial_flavor: [...ARTIFICIAL_FLAVORS].some(s => lower.includes(s)),
                is_artificial_color: [...ARTIFICIAL_COLORS].some(s => lower.includes(s)),
                is_refined_grain: [...REFINED_GRAINS].some(s => lower.includes(s)),
                is_whole_food: [...WHOLE_FOODS].some(s => lower.includes(s))
            };
        }

        function parseIngredients(str) {
            return str.replace(/\([^)]*\)/g, '').split(',').map(i => i.trim()).filter(i => i).map(classifyIngredient);
        }

        function scoreIngredientCount(count) {
            if (count <= 5) return 100;
            if (count <= 10) return 100 - (count - 5) * 4;
            if (count <= 15) return 80 - (count - 10) * 4;
            if (count <= 20) return 60 - (count - 15) * 4;
            return Math.max(0, 40 - (count - 20) * 2);
        }

        function scoreFlagged(ingredients, penalties) {
            let penalty = 0;
            const flags = [];
            const counts = {
                sugars: ingredients.filter(i => i.is_added_sugar).length,
                oils: ingredients.filter(i => i.is_industrial_oil).length,
                preservatives: ingredients.filter(i => i.is_artificial_preservative).length,
                flavors: ingredients.filter(i => i.is_artificial_flavor).length,
                colors: ingredients.filter(i => i.is_artificial_color).length,
                grains: ingredients.filter(i => i.is_refined_grain).length
            };

            if (counts.sugars) { penalty += penalties.added_sugar_first + (counts.sugars - 1) * penalties.added_sugar_additional; flags.push('Added sugars (' + counts.sugars + ')'); }
            if (counts.oils) { penalty += penalties.industrial_oil_first + (counts.oils - 1) * penalties.industrial_oil_additional; flags.push('Industrial oils (' + counts.oils + ')'); }
            if (counts.preservatives) { penalty += penalties.preservative_first + (counts.preservatives - 1) * penalties.preservative_additional; flags.push('Artificial preservatives (' + counts.preservatives + ')'); }
            if (counts.flavors) { penalty += penalties.artificial_flavor; flags.push('Artificial flavors'); }
            if (counts.colors) { penalty += penalties.artificial_color_first + (counts.colors - 1) * penalties.artificial_color_additional; flags.push('Artificial colors (' + counts.colors + ')'); }
            if (counts.grains) { penalty += penalties.refined_grain; flags.push('Refined grains'); }

            return { score: Math.max(0, 100 - penalty), flags };
        }

        function scoreWholeFood(ingredients) {
            if (!ingredients.length) return 0;
            return (ingredients.filter(i => i.is_whole_food).length / ingredients.length) * 100;
        }

        function calculateGrade(score) {
            if (score >= 90) return 'A';
            if (score >= 80) return 'B';
            if (score >= 70) return 'C';
            if (score >= 60) return 'D';
            return 'F';
        }

        function scoreProduct(name, ingredientString) {
            const ingredients = parseIngredients(ingredientString);
            const countScore = scoreIngredientCount(ingredients.length);
            const wholeScore = scoreWholeFood(ingredients);

            const calcTotal = (penalties) => {
                const flagged = scoreFlagged(ingredients, penalties);
                const total = countScore * 0.25 + flagged.score * 0.50 + wholeScore * 0.25;
                return { score: total, grade: calculateGrade(total), flags: flagged.flags };
            };

            const rfk = calcTotal(PENALTIES.rfk);
            const guideline = calcTotal(PENALTIES.guideline);
            const practical = calcTotal(PENALTIES.practical);

            const recommendations = [];
            if (guideline.flags.some(f => f.includes('sugar'))) recommendations.push('Look for unsweetened alternatives');
            if (guideline.flags.some(f => f.includes('oil'))) recommendations.push('Choose products with olive oil or butter instead');
            if (guideline.flags.some(f => f.includes('Artificial'))) recommendations.push('Seek products with recognizable ingredients');

            return {
                product: name,
                ingredient_count: ingredients.length,
                scores: { rfk, guideline, practical },
                flags: guideline.flags,
                recommendations,
                ingredients_analyzed: ingredients.map(i => ({
                    name: i.name,
                    whole_food: i.is_whole_food,
                    flagged: i.is_added_sugar || i.is_industrial_oil || i.is_artificial_preservative || i.is_artificial_flavor || i.is_artificial_color
                }))
            };
        }

        let currentResult = null;
        let currentScoreType = 'rfk';

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        document.querySelectorAll('.score-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.score-type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentScoreType = btn.dataset.type;
                if (currentResult) updateScoreDisplay(currentResult.scores[currentScoreType], currentScoreType);
            });
        });

        document.getElementById('lookup-btn').addEventListener('click', lookupBarcode);
        document.getElementById('barcode').addEventListener('keypress', e => { if (e.key === 'Enter') lookupBarcode(); });
        document.getElementById('analyze-btn').addEventListener('click', analyzeProduct);

        // Scanner state
        let html5QrCode = null;
        let isCameraActive = false;

        // DOM elements for scanner
        const cameraBtn = document.getElementById('camera-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-input');
        const cameraContainer = document.getElementById('camera-container');
        const stopCameraBtn = document.getElementById('stop-camera-btn');
        const pasteZone = document.getElementById('paste-zone');
        const scanResult = document.getElementById('scan-result');
        const scanResultText = document.getElementById('scan-result-text');

        // Initialize scanner
        function initScanner() {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("camera-preview");
            }
        }

        // Show scan result feedback
        function showScanResult(message, isError = false) {
            scanResult.classList.remove('error');
            if (isError) scanResult.classList.add('error');
            scanResultText.textContent = message;
            scanResult.classList.add('visible');
        }

        function hideScanResult() {
            scanResult.classList.remove('visible');
        }

        // Handle successful barcode detection
        async function onBarcodeDetected(decodedText) {
            showScanResult(`Barcode detected: ${decodedText}`);

            // Stop camera if active
            if (isCameraActive) {
                await stopCamera();
            }

            // Fill the barcode input
            document.getElementById('barcode').value = decodedText;

            // Auto-lookup after a short delay
            setTimeout(() => {
                lookupBarcode();
            }, 500);
        }

        // Camera scanning
        cameraBtn.addEventListener('click', async () => {
            initScanner();

            if (isCameraActive) {
                await stopCamera();
                return;
            }

            cameraBtn.classList.add('active');
            uploadBtn.classList.remove('active');
            pasteZone.classList.remove('active');
            cameraContainer.classList.add('active');
            hideScanResult();

            try {
                await html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 150 },
                        aspectRatio: 1.5
                    },
                    onBarcodeDetected,
                    () => {} // Ignore errors during scanning
                );
                isCameraActive = true;
            } catch (err) {
                console.error("Camera error:", err);
                showScanResult("Could not access camera. Try uploading an image instead.", true);
                cameraContainer.classList.remove('active');
                cameraBtn.classList.remove('active');
            }
        });

        // Stop camera
        async function stopCamera() {
            if (html5QrCode && isCameraActive) {
                try {
                    await html5QrCode.stop();
                } catch (e) {}
                isCameraActive = false;
            }
            cameraContainer.classList.remove('active');
            cameraBtn.classList.remove('active');
        }

        stopCameraBtn.addEventListener('click', stopCamera);

        // Capture button - manually trigger scan
        const captureBtn = document.getElementById('capture-btn');
        captureBtn.addEventListener('click', async () => {
            if (!html5QrCode || !isCameraActive) return;

            captureBtn.querySelector('span').textContent = 'Scanning...';

            try {
                // Get the video element from the scanner
                const videoElement = document.querySelector('#camera-preview video');
                if (videoElement) {
                    // Create canvas and capture frame
                    const canvas = document.createElement('canvas');
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(videoElement, 0, 0);

                    // Convert to blob and scan
                    canvas.toBlob(async (blob) => {
                        if (blob) {
                            const file = new File([blob], 'capture.png', { type: 'image/png' });
                            try {
                                const result = await Html5Qrcode.scanFile(file, true);
                                onBarcodeDetected(result);
                            } catch (e) {
                                showScanResult('No barcode found. Try moving closer or adjusting angle.', true);
                            }
                        }
                        captureBtn.querySelector('span').textContent = 'Scan Now';
                    }, 'image/png');
                }
            } catch (e) {
                console.error('Capture error:', e);
                showScanResult('Capture failed. Try again.', true);
                captureBtn.querySelector('span').textContent = 'Scan Now';
            }
        });

        // Upload button - triggers file input
        uploadBtn.addEventListener('click', () => {
            uploadBtn.classList.add('active');
            cameraBtn.classList.remove('active');
            pasteZone.classList.add('active');
            stopCamera();
            fileInput.click();
        });

        // Handle file selection
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                await scanImageFile(file);
            }
            fileInput.value = ''; // Reset for next selection
        });

        // Scan image file for barcode
        async function scanImageFile(file) {
            initScanner();
            hideScanResult();

            try {
                const result = await html5QrCode.scanFile(file, true);
                onBarcodeDetected(result);
            } catch (err) {
                console.error("Scan error:", err);
                showScanResult("No barcode found in image. Try a clearer photo.", true);
            }
        }

        // Paste zone interactions
        pasteZone.addEventListener('click', () => {
            fileInput.click();
        });

        // Drag and drop handlers
        pasteZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            pasteZone.classList.add('dragover');
        });

        pasteZone.addEventListener('dragleave', () => {
            pasteZone.classList.remove('dragover');
        });

        pasteZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            pasteZone.classList.remove('dragover');

            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                await scanImageFile(file);
            }
        });

        // Global paste handler for clipboard images
        document.addEventListener('paste', async (e) => {
            // Only handle paste if we're on the barcode tab
            const barcodeTab = document.getElementById('tab-barcode');
            if (!barcodeTab.classList.contains('active')) return;

            const items = e.clipboardData?.items;
            if (!items) return;

            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        // Show paste zone briefly to indicate we received the image
                        pasteZone.classList.add('active');
                        uploadBtn.classList.add('active');
                        await scanImageFile(file);
                    }
                    break;
                }
            }
        });

        async function lookupBarcode() {
            const barcode = document.getElementById('barcode').value.trim().replace(/\D/g, '');
            if (!barcode) { alert('Please enter a barcode'); return; }

            const btn = document.getElementById('lookup-btn');
            const btnText = document.getElementById('lookup-btn-text');
            btnText.textContent = 'Looking up...';
            btn.disabled = true;

            try {
                // Use combined API lookup
                const product = await lookupProduct(barcode);

                if (!product) {
                    alert('Product not found in any database. Try entering ingredients manually.');
                    return;
                }

                if (!product.ingredients) {
                    alert(`Product found (${product.name}) but no ingredient data available.`);
                    return;
                }

                // Score and display with source attribution
                const result = scoreProduct(product.name, product.ingredients);
                result.dataSource = product.source;
                displayResults(result);
            } catch (e) {
                console.error('Lookup error:', e);
                alert('Error looking up barcode. Please try again.');
            } finally {
                btnText.textContent = 'Look Up Product';
                btn.disabled = false;
            }
        }

        function analyzeProduct() {
            const name = document.getElementById('product-name').value.trim() || 'Unknown Product';
            const ingredients = document.getElementById('ingredients').value.trim();
            if (!ingredients) { alert('Please enter ingredients'); return; }
            displayResults(scoreProduct(name, ingredients));
        }

        function createSvgIcon(type) {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('class', 'flag-icon');
            svg.setAttribute('viewBox', '0 0 24 24');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('stroke', 'currentColor');
            svg.setAttribute('stroke-width', '2');

            if (type === 'warning') {
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', 'M12 9v4m0 4h.01M12 3l9.5 16.5H2.5L12 3z');
                svg.appendChild(path);
            } else {
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z');
                svg.appendChild(path);
            }
            return svg;
        }

        function displayResults(result) {
            currentResult = result;
            currentScoreType = 'rfk';

            document.querySelector('.app').classList.add('has-results');
            document.getElementById('results').classList.add('visible');
            document.getElementById('result-name').textContent = result.product;
            document.getElementById('ingredient-count').textContent = result.ingredient_count;

            // Show data source if available
            const dataSourceEl = document.getElementById('data-source');
            const dataSourceName = document.getElementById('data-source-name');
            if (result.dataSource) {
                dataSourceName.textContent = result.dataSource;
                dataSourceEl.style.display = 'inline-flex';
            } else {
                dataSourceEl.style.display = 'none';
            }

            document.querySelectorAll('.score-type-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.score-type-btn[data-type="rfk"]').classList.add('active');

            updateScoreDisplay(result.scores.rfk, 'rfk');

            const allScores = document.getElementById('all-scores');
            allScores.replaceChildren();
            ['rfk', 'guideline', 'practical'].forEach(type => {
                const s = result.scores[type];
                const div = document.createElement('div');
                div.className = 'mini-score';

                const label = document.createElement('div');
                label.className = 'mini-score-label';
                label.textContent = SCORE_LABELS[type].label;

                const value = document.createElement('div');
                value.className = 'mini-score-value grade-' + s.grade;
                value.textContent = Math.round(s.score);

                const grade = document.createElement('div');
                grade.className = 'mini-score-grade grade-' + s.grade;
                grade.textContent = s.grade;

                div.append(label, value, grade);
                allScores.appendChild(div);
            });

            const flagsList = document.getElementById('flags-list');
            flagsList.replaceChildren();
            if (result.flags.length > 0) {
                result.flags.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'flag-item';
                    div.appendChild(createSvgIcon('warning'));
                    const span = document.createElement('span');
                    span.textContent = f;
                    div.appendChild(span);
                    flagsList.appendChild(div);
                });
            } else {
                const div = document.createElement('div');
                div.className = 'clean-badge';
                div.appendChild(createSvgIcon('check'));
                const span = document.createElement('span');
                span.textContent = 'Clean ingredients  no flags detected';
                div.appendChild(span);
                flagsList.appendChild(div);
            }

            const ingredientsGrid = document.getElementById('ingredients-grid');
            ingredientsGrid.replaceChildren();
            result.ingredients_analyzed.forEach(i => {
                const span = document.createElement('span');
                let cls = 'neutral';
                if (i.flagged) cls = 'flagged';
                else if (i.whole_food) cls = 'whole';
                span.className = 'ingredient-tag ' + cls;
                span.textContent = i.name;
                ingredientsGrid.appendChild(span);
            });

            const recs = document.getElementById('recommendations');
            recs.replaceChildren();
            if (result.recommendations.length > 0) {
                result.recommendations.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'recommendation';
                    const icon = document.createElement('span');
                    icon.className = 'rec-icon';
                    icon.textContent = '';
                    const text = document.createElement('span');
                    text.textContent = r;
                    div.append(icon, text);
                    recs.appendChild(div);
                });
            }

            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ============================================================
        // SERVICE WORKER REGISTRATION (PWA)
        // ============================================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }

        function updateScoreDisplay(scoreData, type) {
            const score = Math.round(scoreData.score);
            const grade = scoreData.grade;

            document.getElementById('score-number').textContent = score;
            const gradeLabel = document.getElementById('score-grade-label');
            gradeLabel.textContent = 'Grade ' + grade;
            gradeLabel.className = 'score-grade grade-' + grade;

            document.getElementById('score-description').textContent = SCORE_LABELS[type].description;

            const ring = document.getElementById('score-ring');
            const circumference = 2 * Math.PI * 80;
            ring.style.stroke = 'url(#' + GRADE_GRADIENTS[grade] + ')';
            ring.style.strokeDashoffset = circumference - (score / 100) * circumference;
        }
    </script>
</body>
</html>
